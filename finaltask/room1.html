<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="../lib/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/osql.js"></script>

    <script>
        $(document).ready(function () {
            execSelect();
        });
        var yokohamaline = [];

        async function　createtable(){
            var sql = 'create table Game(username text not null,answer text not null)'
            await osql.connect(sql);
        }

        osql.requireLogin();
        async function execSelect() {
            var objects = await osql.connect('select*from YokohamaLine');
            yokohamaline = [];
            var objects2 = await osql.connect(`select count(station) as x from YokohamaLine;`);
            console.log(objects2);
            var count = Number(objects2[0].x)
            console.log(count);

            for (var i = 0; i < count; i++) {
                yokohamaline[i] = objects[i].station;
                //console.log(yokohamaline)
            }
        
        
        

        }
        async function startbutton() {   
            var timer ;
            timer = setInterval(renewtable, 2000)  
        }

        async function renewtable(){
            execSelect();
            var game = await osql.connect('select*from Game');
            var html = "";
            html = html + '<table border="1">';
            for(var i = 0;i<game.length;i++){
                var gameobject = game[i];
                html = html + '<tr>';
                html = html + '<td>' + gameobject.username + '</td>';
                html = html + '<td>' + gameobject.answer + '</td>';
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('result').innerHTML = html;
        }

        async function decisionbutton() {
            var answer = document.getElementById('answer').value;
            if (yokohamaline.indexOf(answer) >= 0) {
                console.log("あるよ")
                var sql = `DELETE FROM YokohamaLine WHERE station="${answer}";`
                await osql.connect(sql);
                var name = sessionStorage.getItem('username');
                console.log(name);
                var sql2 = `insert into Game(username,answer)value("${name}","${answer}")`
                await osql.connect(sql2);
                execSelect();
                console.log(yokohamaline)
                
            }
            else {
                console.log("ないよ")
                execSelect();
                var gameover = "Game Over(;_;)"
                document.getElementById('gameover').innerHTML = gameover;
            }
            
        }



        async function resetbutton() {
            var deletion = `drop table Game;`
            await osql.connect(deletion);
            await osql.connect(`drop table YokohamaLine`);
            await osql.connect(`create table YokohamaLine(stationid int not null primary key, station text)`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(1,'東神奈川')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(2,'大口')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(3,'菊名')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(4,'新横浜')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(5,'小机')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(6,'鴨居')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(7,'中山')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(8,'十日市場')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(9,'長津田')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(10,'成瀬')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(11,'町田')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(12,'長津田')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(13,'淵野辺')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(14,'矢部')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(15,'相模原')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(16,'橋本')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(17,'相原')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(18,'八王子みなみ野')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(19,'片倉')`);
            await osql.connect(`insert into YokohamaLine(stationid,station)value(20,'八王子')`);
        }

    </script>

</head>

<body>
    <h1>room1</h1>
    <div>
        <button onclick="createtable()">テーブルを作る</button>
        <button onclick="startbutton()">スタート</button><br>
        解答:<input id="answer" value="" type="textfield">
        <button onclick="decisionbutton()">決定</button>
        <button onclick="resetbutton()">リセット</button>
        <p id = 'result'></p>
        <p id = 'gameover'></p>
    </div>



</body>

</html>